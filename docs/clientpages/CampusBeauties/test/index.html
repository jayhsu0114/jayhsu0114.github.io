<!DOCTYPE html>
<html lang="zh">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SVK83X0L8S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SVK83X0L8S');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排行榜</title>
    <link rel="stylesheet" href="style.css">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const url = 'https://google-sheets-proxy-mk66ircp2a-uc.a.run.app/testcampusbeautiesraise';
            const refreshInterval = 5000; // 每五秒刷新一次

            let previousData = [];

            function fetchData() {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const flatList = data.flat(); // 將多維數組展平為一維數組
                        const cleanedList = cleanPlayerNames(flatList);
                        const filteredList = filterEmptyNames(cleanedList); // 過濾掉空白符
                        const playerCount = countPlayers(filteredList);
                        const sortedPlayers = sortPlayers(playerCount);

                        updateRankings(sortedPlayers);
                        previousData = sortedPlayers; // 更新上一次數據
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }

            function cleanPlayerNames(players) {
                return players.map(player => {
                    // 去掉@，轉為小寫
                    return player ? player.replace('@', '').toLowerCase().trim() : '';
                });
            }

            function filterEmptyNames(players) {
                // 過濾掉空字符串
                return players.filter(player => player !== '');
            }

            function countPlayers(players) {
                return players.reduce((count, player) => {
                    if (player in count) {
                        count[player]++;
                    } else {
                        count[player] = 1;
                    }
                    return count;
                }, {});
            }

            function sortPlayers(playerCount) {
                return Object.entries(playerCount)
                    .map(([name, score]) => ({ name, score }))
                    .sort((a, b) => b.score - a.score); // 按照score降序排序
            }

            function updateRankings(players) {
                const container = document.querySelector('.card-container');
                const existingCards = Array.from(container.children);
                const existingCardMap = new Map();

                // 將現有卡片存入 map 中，以便快速查找
                existingCards.forEach(card => {
                    const name = card.querySelector('.name').textContent;
                    existingCardMap.set(name, card);
                });

                // 新的卡片 Map
                const newCardMap = new Map();

                // 添加新的卡片或更新現有卡片
                players.forEach((player, index) => {
                    let card = existingCardMap.get(player.name);

                    if (card) {
                        // 更新現有卡片的排名和次數
                        const rank = card.querySelector('.rank');
                        const score = card.querySelector('.score');

                        rank.textContent = index + 1;
                        score.textContent = player.score;

                        card.classList.add('rank-change');
                        newCardMap.set(player.name, card);
                        existingCardMap.delete(player.name); // 刪除已處理的卡片
                    } else {
                        // 添加新的卡片
                        card = document.createElement('a');
                        card.className = 'card card-enter';
                        card.href = `https://instagram.com/${player.name}`;
                        card.target = '_blank'; // 在新標籤頁中打開

                        const rank = document.createElement('div');
                        rank.className = 'rank';
                        rank.textContent = index + 1;

                        const content = document.createElement('div');
                        content.className = 'content';

                        const nameElem = document.createElement('div');
                        nameElem.className = 'name';
                        nameElem.textContent = player.name;

                        const scoreElem = document.createElement('div');
                        scoreElem.className = 'score';
                        scoreElem.textContent = player.score;

                        content.appendChild(nameElem);
                        card.appendChild(rank);
                        card.appendChild(content);
                        card.appendChild(scoreElem);
                        container.appendChild(card);

                        // 當卡片添加到 DOM 後，觸發進入動畫
                        requestAnimationFrame(() => {
                            card.classList.remove('card-enter');
                            card.classList.add('card-enter-active');
                        });

                        newCardMap.set(player.name, card);
                    }
                });

                // 移除不存在於新數據中的現有卡片
                existingCardMap.forEach(card => {
                    card.classList.add('card-exit');
                    card.classList.remove('card-enter-active');
                    card.classList.add('card-exit-active');
                    card.addEventListener('transitionend', () => card.remove());
                });

                // 根據新的排名重新排序卡片
                container.innerHTML = '';
                players.forEach((player, index) => {
                    container.appendChild(newCardMap.get(player.name));
                });
            }

            fetchData(); // 初始化載入
            setInterval(fetchData, refreshInterval); // 每五秒刷新一次
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>排行榜</h1>
        <div class="card-container">
            <!-- 排行榜數據將在這裡插入 -->
        </div>
    </div>
</body>
</html>
